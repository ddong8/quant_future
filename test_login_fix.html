<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•ä¿®å¤éªŒè¯</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e8ed;
        }
        .test-section {
            margin: 25px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
            transition: all 0.3s ease;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        .result {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .result.success { background: #f0fff4; border-color: #9ae6b4; color: #22543d; }
        .result.error { background: #fed7d7; border-color: #feb2b2; color: #742a2a; }
        .result.info { background: #ebf8ff; border-color: #90cdf4; color: #2a4365; }
        .api-log {
            background: #1a202c;
            color: #e2e8f0;
            border: none;
            font-size: 12px;
            max-height: 400px;
        }
        .timestamp {
            color: #68d391;
            font-weight: bold;
        }
        .method {
            color: #63b3ed;
            font-weight: bold;
        }
        .url {
            color: #f6e05e;
        }
        .status-success {
            color: #68d391;
        }
        .status-error {
            color: #fc8181;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ ç™»å½•ä¿®å¤éªŒè¯</h1>
            <p>éªŒè¯ç™»å½•åæ˜¯å¦æ­£ç¡®è¯·æ±‚profileå’Œsummaryæ¥å£</p>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ æµ‹è¯•ç›®æ ‡</h3>
            <p>éªŒè¯ç‚¹å‡»ç™»å½•æŒ‰é’®åï¼Œæ˜¯å¦ä¼šè‡ªåŠ¨è¯·æ±‚ä»¥ä¸‹æ¥å£ï¼š</p>
            <ul>
                <li><code>GET /api/user/profile</code> - è·å–ç”¨æˆ·èµ„æ–™</li>
                <li><code>GET /api/dashboard/summary</code> - è·å–ä»ªè¡¨æ¿æ‘˜è¦</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ“¡ APIè¯·æ±‚ç›‘æ§</h3>
            <button onclick="startMonitoring()" id="startBtn">å¼€å§‹ç›‘æ§</button>
            <button onclick="stopMonitoring()" id="stopBtn" disabled>åœæ­¢ç›‘æ§</button>
            <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
            <div id="apiLog" class="result api-log">ç‚¹å‡»"å¼€å§‹ç›‘æ§"æ¥æŸ¥çœ‹APIè¯·æ±‚...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ”‘ ç™»å½•æµ‹è¯•</h3>
            <button onclick="testLogin()" id="loginBtn">æ¨¡æ‹Ÿç™»å½• (admin/admin123)</button>
            <button onclick="testLogout()" id="logoutBtn" disabled>ç™»å‡º</button>
            <div id="loginResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š ç»“æœåˆ†æ</h3>
            <div id="analysis" class="result info">ç­‰å¾…æµ‹è¯•ç»“æœ...</div>
        </div>
    </div>

    <script>
        let monitoring = false;
        let apiCalls = [];
        let authToken = null;

        // é…ç½®axios
        const api = axios.create({
            baseURL: 'http://localhost:8000',
            timeout: 15000,
            headers: { 'Content-Type': 'application/json' }
        });

        // è¯·æ±‚æ‹¦æˆªå™¨
        api.interceptors.request.use(config => {
            if (authToken) {
                config.headers.Authorization = `Bearer ${authToken}`;
            }
            
            if (monitoring) {
                logApiCall('REQUEST', config.method.toUpperCase(), config.url, null, config.data);
            }
            
            return config;
        });

        // å“åº”æ‹¦æˆªå™¨
        api.interceptors.response.use(
            response => {
                if (monitoring) {
                    logApiCall('RESPONSE', response.config.method.toUpperCase(), response.config.url, response.status, response.data);
                }
                return response;
            },
            error => {
                if (monitoring) {
                    logApiCall('ERROR', error.config?.method?.toUpperCase() || 'UNKNOWN', error.config?.url || 'UNKNOWN', error.response?.status, error.response?.data);
                }
                return Promise.reject(error);
            }
        );

        function logApiCall(type, method, url, status, data) {
            const timestamp = new Date().toLocaleTimeString();
            const call = { timestamp, type, method, url, status, data };
            apiCalls.push(call);
            updateApiLog();
        }

        function updateApiLog() {
            const logElement = document.getElementById('apiLog');
            const logText = apiCalls.map(call => {
                let line = `<span class="timestamp">[${call.timestamp}]</span> `;
                line += `<span class="method">${call.method}</span> `;
                line += `<span class="url">${call.url}</span>`;
                
                if (call.status) {
                    const statusClass = call.status >= 200 && call.status < 300 ? 'status-success' : 'status-error';
                    line += ` <span class="${statusClass}">(${call.status})</span>`;
                }
                
                if (call.type === 'RESPONSE' && call.data?.success) {
                    line += ` <span class="status-success">âœ…</span>`;
                } else if (call.type === 'ERROR') {
                    line += ` <span class="status-error">âŒ</span>`;
                }
                
                return line;
            }).join('\n');
            
            logElement.innerHTML = logText || 'æš‚æ— APIè¯·æ±‚è®°å½•';
            logElement.scrollTop = logElement.scrollHeight;
        }

        function startMonitoring() {
            monitoring = true;
            apiCalls = [];
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('apiLog').innerHTML = '<span class="status-success">ğŸ“¡ ç›‘æ§å·²å¼€å§‹ï¼Œç­‰å¾…APIè¯·æ±‚...</span>';
        }

        function stopMonitoring() {
            monitoring = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            // åˆ†æç»“æœ
            analyzeResults();
        }

        function clearLog() {
            apiCalls = [];
            document.getElementById('apiLog').innerHTML = 'APIè¯·æ±‚æ—¥å¿—å·²æ¸…é™¤';
            document.getElementById('analysis').textContent = 'ç­‰å¾…æµ‹è¯•ç»“æœ...';
            document.getElementById('analysis').className = 'result info';
        }

        async function testLogin() {
            try {
                document.getElementById('loginResult').textContent = 'ğŸ”„ æ­£åœ¨ç™»å½•...';
                document.getElementById('loginResult').className = 'result info';
                
                const response = await api.post('/api/v1/auth/login', {
                    username: 'admin',
                    password: 'admin123'
                });
                
                if (response.data.success) {
                    authToken = response.data.data.access_token;
                    document.getElementById('loginBtn').disabled = true;
                    document.getElementById('logoutBtn').disabled = false;
                    
                    document.getElementById('loginResult').textContent = 
                        `âœ… ç™»å½•æˆåŠŸï¼\n` +
                        `ç”¨æˆ·: ${response.data.data.username}\n` +
                        `è§’è‰²: ${response.data.data.role}\n` +
                        `Token: ${authToken.substring(0, 50)}...`;
                    document.getElementById('loginResult').className = 'result success';
                    
                    // ç­‰å¾…ä¸€æ®µæ—¶é—´è®©å¯èƒ½çš„åç»­APIè°ƒç”¨å®Œæˆ
                    setTimeout(() => {
                        if (monitoring) {
                            analyzeResults();
                        }
                    }, 2000);
                } else {
                    throw new Error(response.data.message || 'ç™»å½•å¤±è´¥');
                }
            } catch (error) {
                document.getElementById('loginResult').textContent = `âŒ ç™»å½•å¤±è´¥: ${error.message}`;
                document.getElementById('loginResult').className = 'result error';
            }
        }

        async function testLogout() {
            try {
                await api.post('/api/v1/auth/logout');
            } catch (error) {
                // å¿½ç•¥ç™»å‡ºé”™è¯¯
            } finally {
                authToken = null;
                document.getElementById('loginBtn').disabled = false;
                document.getElementById('logoutBtn').disabled = true;
                document.getElementById('loginResult').textContent = 'âœ… å·²ç™»å‡º';
                document.getElementById('loginResult').className = 'result success';
            }
        }

        function analyzeResults() {
            const profileCalls = apiCalls.filter(call => 
                call.url.includes('/api/user/profile') && call.type === 'RESPONSE'
            );
            const summaryCalls = apiCalls.filter(call => 
                call.url.includes('/api/dashboard/summary') && call.type === 'RESPONSE'
            );
            
            let analysis = 'ğŸ“Š æµ‹è¯•ç»“æœåˆ†æ:\n\n';
            
            // æ£€æŸ¥profileæ¥å£è°ƒç”¨
            if (profileCalls.length > 0) {
                analysis += `âœ… ç”¨æˆ·èµ„æ–™æ¥å£ (profile): å·²è°ƒç”¨ ${profileCalls.length} æ¬¡\n`;
                profileCalls.forEach((call, index) => {
                    analysis += `   ${index + 1}. [${call.timestamp}] çŠ¶æ€: ${call.status}\n`;
                });
            } else {
                analysis += `âŒ ç”¨æˆ·èµ„æ–™æ¥å£ (profile): æœªè°ƒç”¨\n`;
            }
            
            analysis += '\n';
            
            // æ£€æŸ¥summaryæ¥å£è°ƒç”¨
            if (summaryCalls.length > 0) {
                analysis += `âœ… ä»ªè¡¨æ¿æ‘˜è¦æ¥å£ (summary): å·²è°ƒç”¨ ${summaryCalls.length} æ¬¡\n`;
                summaryCalls.forEach((call, index) => {
                    analysis += `   ${index + 1}. [${call.timestamp}] çŠ¶æ€: ${call.status}\n`;
                });
            } else {
                analysis += `âŒ ä»ªè¡¨æ¿æ‘˜è¦æ¥å£ (summary): æœªè°ƒç”¨\n`;
            }
            
            analysis += '\n';
            
            // æ€»ç»“
            const bothCalled = profileCalls.length > 0 && summaryCalls.length > 0;
            if (bothCalled) {
                analysis += 'ğŸ‰ æµ‹è¯•é€šè¿‡ï¼ç™»å½•åæ­£ç¡®è¯·æ±‚äº†profileå’Œsummaryæ¥å£ã€‚';
            } else {
                analysis += 'âš ï¸ æµ‹è¯•æœªé€šè¿‡ï¼ç™»å½•åç¼ºå°‘å¿…è¦çš„APIè°ƒç”¨ã€‚';
                analysis += '\n\nğŸ’¡ å¯èƒ½çš„åŸå› :';
                analysis += '\n1. å‰ç«¯ç™»å½•é€»è¾‘ä¸­ç¼ºå°‘APIè°ƒç”¨';
                analysis += '\n2. APIè°ƒç”¨è¢«å¼‚æ­¥æ‰§è¡Œï¼Œä½†é¡µé¢è·³è½¬è¿‡å¿«';
                analysis += '\n3. ç»„ä»¶æ²¡æœ‰æ­£ç¡®ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–';
            }
            
            document.getElementById('analysis').textContent = analysis;
            document.getElementById('analysis').className = bothCalled ? 'result success' : 'result error';
        }

        // é¡µé¢åŠ è½½æ—¶çš„è¯´æ˜
        window.onload = function() {
            document.getElementById('loginResult').textContent = 
                'ğŸ“‹ æµ‹è¯•æ­¥éª¤:\n' +
                '1. ç‚¹å‡»"å¼€å§‹ç›‘æ§"å¼€å§‹è®°å½•APIè¯·æ±‚\n' +
                '2. ç‚¹å‡»"æ¨¡æ‹Ÿç™»å½•"æ‰§è¡Œç™»å½•æµç¨‹\n' +
                '3. è§‚å¯Ÿæ˜¯å¦è‡ªåŠ¨è°ƒç”¨profileå’Œsummaryæ¥å£\n' +
                '4. æŸ¥çœ‹ç»“æœåˆ†æ';
            document.getElementById('loginResult').className = 'result info';
        };
    </script>
</body>
</html>