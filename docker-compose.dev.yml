# å¼€å‘ç¯å¢ƒ Docker Compose é…ç½®
# ä½¿ç”¨æ–¹æ³•: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  # æ•°æ®åº“åˆå§‹åŒ–å®¹å™¨ - å¼€å‘ç¯å¢ƒé…ç½®
  db-init:
    environment:
      - DEBUG=true
      - LOG_LEVEL=DEBUG
    volumes:
      - ./backend:/app:ro  # åªè¯»æŒ‚è½½ï¼Œé˜²æ­¢å®¹å™¨ä¿®æ”¹æºç 
    healthcheck:
      test: ["CMD", "python", "init_healthcheck.py"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # åç«¯æœåŠ¡ - å¼€å‘ç¯å¢ƒé…ç½®
  backend:
    environment:
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - UVICORN_RELOAD=true
      - WORKER_PROCESSES=1  # å¼€å‘ç¯å¢ƒä½¿ç”¨å•è¿›ç¨‹
      - DB_POOL_SIZE=5      # å¼€å‘ç¯å¢ƒå‡å°‘è¿æ¥æ± å¤§å°
      - REDIS_MAX_CONNECTIONS=20
    volumes:
      - ./backend:/app  # å¼€å‘ç¯å¢ƒå…è®¸çƒ­é‡è½½
    command: ["python", "start_backend.py"]
    # å¼€å‘ç¯å¢ƒçš„å¥åº·æ£€æŸ¥æ›´é¢‘ç¹
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health/"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  # å‰ç«¯æœåŠ¡ - å¼€å‘ç¯å¢ƒé…ç½®
  frontend:
    environment:
      - NODE_ENV=development
      - VITE_API_BASE_URL=http://localhost:8000/api/v1
      - VITE_WS_BASE_URL=ws://localhost:8000/api/v1/ws
      - VITE_API_PROXY_TARGET=http://backend:8000
      - VITE_WS_PROXY_TARGET=ws://backend:8000
      - VITE_ENABLE_DEBUG=true
      - VITE_REQUEST_TIMEOUT=10000  # å¼€å‘ç¯å¢ƒè¾ƒçŸ­è¶…æ—¶
    command: >
      sh -c "
        echo 'ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–...' &&
        npm install --silent &&
        echo 'ğŸ” æµ‹è¯•åç«¯è¿æ¥...' &&
        timeout 10 sh -c 'until wget -q --spider http://backend:8000/api/v1/health/; do echo \"ç­‰å¾…åç«¯æœåŠ¡...\"; sleep 2; done' &&
        echo 'ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨...' &&
        npm run dev -- --host 0.0.0.0 --port 3000
      "
    # å¼€å‘ç¯å¢ƒçš„å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  # å¼€å‘å·¥å…·å®¹å™¨
  dev-tools:
    build:
      context: ./backend
      dockerfile: Dockerfile.init
    container_name: trading_dev_tools
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/trading_db
      - REDIS_URL=redis://redis:6379/0
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=my-super-secret-auth-token
      - INFLUXDB_ORG=trading-org
      - INFLUXDB_BUCKET=market-data
    depends_on:
      - postgres
      - redis
      - influxdb
    volumes:
      - ./backend:/app
      - ./logs:/var/log/trading
    profiles:
      - tools  # åªåœ¨æŒ‡å®š profile æ—¶å¯åŠ¨
    command: >
      sh -c "
        echo 'ğŸ› ï¸  å¼€å‘å·¥å…·å®¹å™¨å·²å¯åŠ¨' &&
        echo 'å¯ç”¨å‘½ä»¤:' &&
        echo '  python check_db_status.py - æ£€æŸ¥æ•°æ®åº“çŠ¶æ€' &&
        echo '  python wait_for_db.py - ç­‰å¾…æ•°æ®åº“å°±ç»ª' &&
        echo '  python check_init_status.py - æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€' &&
        echo '  python validate_config.py - éªŒè¯é…ç½®' &&
        tail -f /dev/null
      "