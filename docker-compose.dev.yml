# å¼€å‘ç¯å¢ƒ Docker Compose é…ç½®
# ä½¿ç”¨æ–¹æ³•: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  # æ•°æ®åº“åˆå§‹åŒ–å®¹å™¨ - å¼€å‘ç¯å¢ƒé…ç½®
  db-init:
    environment:
      - DEBUG=true
      - LOG_LEVEL=DEBUG
    volumes:
      - ./backend:/app:ro  # åªè¯»æŒ‚è½½ï¼Œé˜²æ­¢å®¹å™¨ä¿®æ”¹æºç 
    healthcheck:
      test: ["CMD", "python", "init_healthcheck.py"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # åç«¯æœåŠ¡ - å¼€å‘ç¯å¢ƒé…ç½®
  backend:
    environment:
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - RELOAD=true
    volumes:
      - ./backend:/app  # å¼€å‘ç¯å¢ƒå…è®¸çƒ­é‡è½½
    command: >
      sh -c "
        echo 'â³ ç­‰å¾…æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ...' &&
        python check_init_status.py --wait --timeout 300 &&
        echo 'ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨...' &&
        uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
      "

  # å‰ç«¯æœåŠ¡ - å¼€å‘ç¯å¢ƒé…ç½®
  frontend:
    environment:
      - NODE_ENV=development
      - VITE_API_BASE_URL=http://localhost:8000/api/v1
      - VITE_WS_BASE_URL=ws://localhost:8000/api/v1/ws
    command: >
      sh -c "
        echo 'ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–...' &&
        npm install --silent &&
        echo 'ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨...' &&
        npm run dev -- --host 0.0.0.0 --port 3000
      "

  # å¼€å‘å·¥å…·å®¹å™¨
  dev-tools:
    build:
      context: ./backend
      dockerfile: Dockerfile.init
    container_name: trading_dev_tools
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/trading_db
      - REDIS_URL=redis://redis:6379/0
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=my-super-secret-auth-token
      - INFLUXDB_ORG=trading-org
      - INFLUXDB_BUCKET=market-data
    depends_on:
      - postgres
      - redis
      - influxdb
    volumes:
      - ./backend:/app
      - ./logs:/var/log/trading
    profiles:
      - tools  # åªåœ¨æŒ‡å®š profile æ—¶å¯åŠ¨
    command: >
      sh -c "
        echo 'ğŸ› ï¸  å¼€å‘å·¥å…·å®¹å™¨å·²å¯åŠ¨' &&
        echo 'å¯ç”¨å‘½ä»¤:' &&
        echo '  python check_db_status.py - æ£€æŸ¥æ•°æ®åº“çŠ¶æ€' &&
        echo '  python wait_for_db.py - ç­‰å¾…æ•°æ®åº“å°±ç»ª' &&
        echo '  python check_init_status.py - æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€' &&
        echo '  python validate_config.py - éªŒè¯é…ç½®' &&
        tail -f /dev/null
      "