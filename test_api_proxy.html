<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIä»£ç†æµ‹è¯•</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e8ed;
        }
        .test-section {
            margin: 25px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
            transition: all 0.3s ease;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        .result {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .result.success { background: #f0fff4; border-color: #9ae6b4; color: #22543d; }
        .result.error { background: #fed7d7; border-color: #feb2b2; color: #742a2a; }
        .result.info { background: #ebf8ff; border-color: #90cdf4; color: #2a4365; }
        .url-test {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }
        .url-test code {
            flex: 1;
            background: #f1f5f9;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #cbd5e0;
        }
        .status-dot.success { background: #48bb78; }
        .status-dot.error { background: #f56565; }
        .status-dot.loading { background: #ed8936; animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ APIä»£ç†æµ‹è¯•</h1>
            <p>æµ‹è¯•å‰ç«¯Nginxä»£ç†æ˜¯å¦æ­£ç¡®è½¬å‘APIè¯·æ±‚åˆ°åç«¯</p>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <p>å‰ç«¯åº”ç”¨è¿è¡Œåœ¨ <code>http://localhost:3000</code>ï¼Œåç«¯APIè¿è¡Œåœ¨ <code>http://localhost:8000</code></p>
            <p>å‰ç«¯Nginxé…ç½®äº†ä»£ç†è§„åˆ™ï¼š<code>/api/*</code> â†’ <code>http://backend:8000</code></p>
            <p>æˆ‘ä»¬éœ€è¦éªŒè¯ä»¥ä¸‹è·¯å¾„æ˜¯å¦æ­£ç¡®ä»£ç†ï¼š</p>
            <ul>
                <li><code>/api/v1/auth/login</code> - ç™»å½•æ¥å£</li>
                <li><code>/api/user/profile</code> - ç”¨æˆ·èµ„æ–™æ¥å£ï¼ˆå…¼å®¹æ€§è·¯ç”±ï¼‰</li>
                <li><code>/api/dashboard/summary</code> - ä»ªè¡¨æ¿æ‘˜è¦æ¥å£ï¼ˆå…¼å®¹æ€§è·¯ç”±ï¼‰</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª APIè·¯å¾„æµ‹è¯•</h3>
            <div id="urlTests">
                <div class="url-test">
                    <div class="status-dot" id="status-login"></div>
                    <code>POST /api/v1/auth/login</code>
                    <button onclick="testLogin()">æµ‹è¯•</button>
                </div>
                <div class="url-test">
                    <div class="status-dot" id="status-profile"></div>
                    <code>GET /api/user/profile</code>
                    <button onclick="testProfile()" id="profileBtn" disabled>æµ‹è¯•</button>
                </div>
                <div class="url-test">
                    <div class="status-dot" id="status-summary"></div>
                    <code>GET /api/dashboard/summary</code>
                    <button onclick="testSummary()" id="summaryBtn" disabled>æµ‹è¯•</button>
                </div>
            </div>
            <div id="testResult" class="result info">ç‚¹å‡»"æµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•å„ä¸ªAPIç«¯ç‚¹...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ”„ å®Œæ•´æµç¨‹æµ‹è¯•</h3>
            <button onclick="runFullTest()">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤ç»“æœ</button>
            <div id="fullTestResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ” é…ç½®æ£€æŸ¥</h3>
            <button onclick="checkConfig()">æ£€æŸ¥å‰ç«¯é…ç½®</button>
            <div id="configResult" class="result info"></div>
        </div>
    </div>

    <script>
        let authToken = null;
        let testResults = [];

        // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè®©Nginxä»£ç†å¤„ç†
        const api = axios.create({
            baseURL: '/api',  // ç›¸å¯¹è·¯å¾„ï¼Œä¼šè¢«Nginxä»£ç†åˆ°åç«¯
            timeout: 15000,
            headers: { 'Content-Type': 'application/json' }
        });

        // è¯·æ±‚æ‹¦æˆªå™¨
        api.interceptors.request.use(config => {
            if (authToken) {
                config.headers.Authorization = `Bearer ${authToken}`;
            }
            logResult(`ğŸ”„ è¯·æ±‚: ${config.method.toUpperCase()} ${config.url}`);
            return config;
        });

        // å“åº”æ‹¦æˆªå™¨
        api.interceptors.response.use(
            response => {
                logResult(`âœ… å“åº”: ${response.status} ${response.config.url}`);
                return response;
            },
            error => {
                logResult(`âŒ é”™è¯¯: ${error.response?.status || 'NETWORK'} ${error.config?.url} - ${error.response?.data?.error_message || error.message}`);
                return Promise.reject(error);
            }
        );

        function logResult(message) {
            testResults.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            updateDisplay();
        }

        function updateDisplay() {
            const resultElement = document.getElementById('testResult');
            resultElement.textContent = testResults.join('\n');
            resultElement.scrollTop = resultElement.scrollHeight;
        }

        function updateStatus(id, status) {
            const element = document.getElementById(id);
            element.className = `status-dot ${status}`;
        }

        async function testLogin() {
            updateStatus('status-login', 'loading');
            try {
                const response = await api.post('/v1/auth/login', {
                    username: 'admin',
                    password: 'admin123'
                });
                
                if (response.data.success) {
                    authToken = response.data.data.access_token;
                    updateStatus('status-login', 'success');
                    document.getElementById('profileBtn').disabled = false;
                    document.getElementById('summaryBtn').disabled = false;
                    logResult('âœ… ç™»å½•æˆåŠŸï¼Œè·å–åˆ°token');
                } else {
                    throw new Error('ç™»å½•å“åº”æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                updateStatus('status-login', 'error');
                logResult(`âŒ ç™»å½•å¤±è´¥: ${error.message}`);
            }
        }

        async function testProfile() {
            if (!authToken) {
                logResult('âš ï¸ è¯·å…ˆç™»å½•è·å–token');
                return;
            }

            updateStatus('status-profile', 'loading');
            try {
                const response = await api.get('/user/profile');
                if (response.data.success) {
                    updateStatus('status-profile', 'success');
                    logResult('âœ… ç”¨æˆ·èµ„æ–™è·å–æˆåŠŸ');
                } else {
                    throw new Error('å“åº”æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                updateStatus('status-profile', 'error');
                logResult(`âŒ ç”¨æˆ·èµ„æ–™è·å–å¤±è´¥: ${error.message}`);
            }
        }

        async function testSummary() {
            if (!authToken) {
                logResult('âš ï¸ è¯·å…ˆç™»å½•è·å–token');
                return;
            }

            updateStatus('status-summary', 'loading');
            try {
                const response = await api.get('/dashboard/summary');
                if (response.data.success) {
                    updateStatus('status-summary', 'success');
                    logResult('âœ… ä»ªè¡¨æ¿æ‘˜è¦è·å–æˆåŠŸ');
                } else {
                    throw new Error('å“åº”æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                updateStatus('status-summary', 'error');
                logResult(`âŒ ä»ªè¡¨æ¿æ‘˜è¦è·å–å¤±è´¥: ${error.message}`);
            }
        }

        async function runFullTest() {
            testResults = [];
            logResult('ğŸš€ å¼€å§‹å®Œæ•´APIä»£ç†æµ‹è¯•...');
            
            // é‡ç½®çŠ¶æ€
            ['status-login', 'status-profile', 'status-summary'].forEach(id => {
                updateStatus(id.replace('status-', ''), '');
            });
            
            try {
                // æµ‹è¯•ç™»å½•
                await testLogin();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // æµ‹è¯•ç”¨æˆ·èµ„æ–™
                await testProfile();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // æµ‹è¯•ä»ªè¡¨æ¿æ‘˜è¦
                await testSummary();
                
                logResult('ğŸ‰ å®Œæ•´æµ‹è¯•å®Œæˆï¼');
                
                // åˆ†æç»“æœ
                const successCount = document.querySelectorAll('.status-dot.success').length;
                const totalCount = 3;
                
                if (successCount === totalCount) {
                    document.getElementById('fullTestResult').textContent = 
                        'ğŸ‰ æ‰€æœ‰APIä»£ç†æµ‹è¯•é€šè¿‡ï¼\n' +
                        'âœ… å‰ç«¯Nginxä»£ç†é…ç½®æ­£ç¡®\n' +
                        'âœ… åç«¯å…¼å®¹æ€§è·¯ç”±å·¥ä½œæ­£å¸¸\n' +
                        'âœ… è®¤è¯æœºåˆ¶æ­£å¸¸å·¥ä½œ';
                    document.getElementById('fullTestResult').className = 'result success';
                } else {
                    document.getElementById('fullTestResult').textContent = 
                        `âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ (${successCount}/${totalCount})\n` +
                        'è¯·æ£€æŸ¥å¤±è´¥çš„APIç«¯ç‚¹å’Œé”™è¯¯ä¿¡æ¯';
                    document.getElementById('fullTestResult').className = 'result error';
                }
                
            } catch (error) {
                logResult(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`);
                document.getElementById('fullTestResult').textContent = 
                    'âŒ æµ‹è¯•å¤±è´¥\n' +
                    'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡çŠ¶æ€';
                document.getElementById('fullTestResult').className = 'result error';
            }
        }

        function clearResults() {
            testResults = [];
            authToken = null;
            document.getElementById('testResult').textContent = 'ç»“æœå·²æ¸…é™¤';
            document.getElementById('fullTestResult').textContent = '';
            document.getElementById('profileBtn').disabled = true;
            document.getElementById('summaryBtn').disabled = true;
            
            // é‡ç½®çŠ¶æ€æŒ‡ç¤ºå™¨
            ['login', 'profile', 'summary'].forEach(name => {
                updateStatus(`status-${name}`, '');
            });
        }

        function checkConfig() {
            const config = {
                'å½“å‰é¡µé¢URL': window.location.href,
                'å‰ç«¯æœåŠ¡': 'http://localhost:3000',
                'åç«¯æœåŠ¡': 'http://localhost:8000',
                'API Base URL': '/api (ç›¸å¯¹è·¯å¾„)',
                'Nginxä»£ç†è§„åˆ™': '/api/* â†’ http://backend:8000',
                'æµ‹è¯•ç«¯ç‚¹': [
                    'POST /api/v1/auth/login',
                    'GET /api/user/profile',
                    'GET /api/dashboard/summary'
                ]
            };
            
            let configText = 'ğŸ” å‰ç«¯é…ç½®ä¿¡æ¯:\n\n';
            for (const [key, value] of Object.entries(config)) {
                if (Array.isArray(value)) {
                    configText += `${key}:\n`;
                    value.forEach(item => configText += `  - ${item}\n`);
                } else {
                    configText += `${key}: ${value}\n`;
                }
            }
            
            configText += '\nğŸ’¡ è¯´æ˜:\n';
            configText += '- å‰ç«¯ä½¿ç”¨ç›¸å¯¹è·¯å¾„ /api ä½œä¸ºbaseURL\n';
            configText += '- Nginxå°† /api/* è¯·æ±‚ä»£ç†åˆ°åç«¯å®¹å™¨\n';
            configText += '- åç«¯æä¾›å…¼å®¹æ€§è·¯ç”±æ”¯æŒæ—§çš„APIè·¯å¾„\n';
            
            document.getElementById('configResult').textContent = configText;
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        window.onload = function() {
            checkConfig();
        };
    </script>
</body>
</html>