<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API代理测试</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e8ed;
        }
        .test-section {
            margin: 25px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
            transition: all 0.3s ease;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        .result {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .result.success { background: #f0fff4; border-color: #9ae6b4; color: #22543d; }
        .result.error { background: #fed7d7; border-color: #feb2b2; color: #742a2a; }
        .result.info { background: #ebf8ff; border-color: #90cdf4; color: #2a4365; }
        .url-test {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }
        .url-test code {
            flex: 1;
            background: #f1f5f9;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #cbd5e0;
        }
        .status-dot.success { background: #48bb78; }
        .status-dot.error { background: #f56565; }
        .status-dot.loading { background: #ed8936; animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 API代理测试</h1>
            <p>测试前端Nginx代理是否正确转发API请求到后端</p>
        </div>

        <div class="test-section">
            <h3>📋 测试说明</h3>
            <p>前端应用运行在 <code>http://localhost:3000</code>，后端API运行在 <code>http://localhost:8000</code></p>
            <p>前端Nginx配置了代理规则：<code>/api/*</code> → <code>http://backend:8000</code></p>
            <p>我们需要验证以下路径是否正确代理：</p>
            <ul>
                <li><code>/api/v1/auth/login</code> - 登录接口</li>
                <li><code>/api/user/profile</code> - 用户资料接口（兼容性路由）</li>
                <li><code>/api/dashboard/summary</code> - 仪表板摘要接口（兼容性路由）</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>🧪 API路径测试</h3>
            <div id="urlTests">
                <div class="url-test">
                    <div class="status-dot" id="status-login"></div>
                    <code>POST /api/v1/auth/login</code>
                    <button onclick="testLogin()">测试</button>
                </div>
                <div class="url-test">
                    <div class="status-dot" id="status-profile"></div>
                    <code>GET /api/user/profile</code>
                    <button onclick="testProfile()" id="profileBtn" disabled>测试</button>
                </div>
                <div class="url-test">
                    <div class="status-dot" id="status-summary"></div>
                    <code>GET /api/dashboard/summary</code>
                    <button onclick="testSummary()" id="summaryBtn" disabled>测试</button>
                </div>
            </div>
            <div id="testResult" class="result info">点击"测试"按钮开始测试各个API端点...</div>
        </div>

        <div class="test-section">
            <h3>🔄 完整流程测试</h3>
            <button onclick="runFullTest()">🚀 运行完整测试</button>
            <button onclick="clearResults()">🧹 清除结果</button>
            <div id="fullTestResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>🔍 配置检查</h3>
            <button onclick="checkConfig()">检查前端配置</button>
            <div id="configResult" class="result info"></div>
        </div>
    </div>

    <script>
        let authToken = null;
        let testResults = [];

        // 使用相对路径，让Nginx代理处理
        const api = axios.create({
            baseURL: '/api',  // 相对路径，会被Nginx代理到后端
            timeout: 15000,
            headers: { 'Content-Type': 'application/json' }
        });

        // 请求拦截器
        api.interceptors.request.use(config => {
            if (authToken) {
                config.headers.Authorization = `Bearer ${authToken}`;
            }
            logResult(`🔄 请求: ${config.method.toUpperCase()} ${config.url}`);
            return config;
        });

        // 响应拦截器
        api.interceptors.response.use(
            response => {
                logResult(`✅ 响应: ${response.status} ${response.config.url}`);
                return response;
            },
            error => {
                logResult(`❌ 错误: ${error.response?.status || 'NETWORK'} ${error.config?.url} - ${error.response?.data?.error_message || error.message}`);
                return Promise.reject(error);
            }
        );

        function logResult(message) {
            testResults.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            updateDisplay();
        }

        function updateDisplay() {
            const resultElement = document.getElementById('testResult');
            resultElement.textContent = testResults.join('\n');
            resultElement.scrollTop = resultElement.scrollHeight;
        }

        function updateStatus(id, status) {
            const element = document.getElementById(id);
            element.className = `status-dot ${status}`;
        }

        async function testLogin() {
            updateStatus('status-login', 'loading');
            try {
                const response = await api.post('/v1/auth/login', {
                    username: 'admin',
                    password: 'admin123'
                });
                
                if (response.data.success) {
                    authToken = response.data.data.access_token;
                    updateStatus('status-login', 'success');
                    document.getElementById('profileBtn').disabled = false;
                    document.getElementById('summaryBtn').disabled = false;
                    logResult('✅ 登录成功，获取到token');
                } else {
                    throw new Error('登录响应格式错误');
                }
            } catch (error) {
                updateStatus('status-login', 'error');
                logResult(`❌ 登录失败: ${error.message}`);
            }
        }

        async function testProfile() {
            if (!authToken) {
                logResult('⚠️ 请先登录获取token');
                return;
            }

            updateStatus('status-profile', 'loading');
            try {
                const response = await api.get('/user/profile');
                if (response.data.success) {
                    updateStatus('status-profile', 'success');
                    logResult('✅ 用户资料获取成功');
                } else {
                    throw new Error('响应格式错误');
                }
            } catch (error) {
                updateStatus('status-profile', 'error');
                logResult(`❌ 用户资料获取失败: ${error.message}`);
            }
        }

        async function testSummary() {
            if (!authToken) {
                logResult('⚠️ 请先登录获取token');
                return;
            }

            updateStatus('status-summary', 'loading');
            try {
                const response = await api.get('/dashboard/summary');
                if (response.data.success) {
                    updateStatus('status-summary', 'success');
                    logResult('✅ 仪表板摘要获取成功');
                } else {
                    throw new Error('响应格式错误');
                }
            } catch (error) {
                updateStatus('status-summary', 'error');
                logResult(`❌ 仪表板摘要获取失败: ${error.message}`);
            }
        }

        async function runFullTest() {
            testResults = [];
            logResult('🚀 开始完整API代理测试...');
            
            // 重置状态
            ['status-login', 'status-profile', 'status-summary'].forEach(id => {
                updateStatus(id.replace('status-', ''), '');
            });
            
            try {
                // 测试登录
                await testLogin();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 测试用户资料
                await testProfile();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 测试仪表板摘要
                await testSummary();
                
                logResult('🎉 完整测试完成！');
                
                // 分析结果
                const successCount = document.querySelectorAll('.status-dot.success').length;
                const totalCount = 3;
                
                if (successCount === totalCount) {
                    document.getElementById('fullTestResult').textContent = 
                        '🎉 所有API代理测试通过！\n' +
                        '✅ 前端Nginx代理配置正确\n' +
                        '✅ 后端兼容性路由工作正常\n' +
                        '✅ 认证机制正常工作';
                    document.getElementById('fullTestResult').className = 'result success';
                } else {
                    document.getElementById('fullTestResult').textContent = 
                        `⚠️ 部分测试失败 (${successCount}/${totalCount})\n` +
                        '请检查失败的API端点和错误信息';
                    document.getElementById('fullTestResult').className = 'result error';
                }
                
            } catch (error) {
                logResult(`❌ 测试过程中出现错误: ${error.message}`);
                document.getElementById('fullTestResult').textContent = 
                    '❌ 测试失败\n' +
                    '请检查网络连接和服务状态';
                document.getElementById('fullTestResult').className = 'result error';
            }
        }

        function clearResults() {
            testResults = [];
            authToken = null;
            document.getElementById('testResult').textContent = '结果已清除';
            document.getElementById('fullTestResult').textContent = '';
            document.getElementById('profileBtn').disabled = true;
            document.getElementById('summaryBtn').disabled = true;
            
            // 重置状态指示器
            ['login', 'profile', 'summary'].forEach(name => {
                updateStatus(`status-${name}`, '');
            });
        }

        function checkConfig() {
            const config = {
                '当前页面URL': window.location.href,
                '前端服务': 'http://localhost:3000',
                '后端服务': 'http://localhost:8000',
                'API Base URL': '/api (相对路径)',
                'Nginx代理规则': '/api/* → http://backend:8000',
                '测试端点': [
                    'POST /api/v1/auth/login',
                    'GET /api/user/profile',
                    'GET /api/dashboard/summary'
                ]
            };
            
            let configText = '🔍 前端配置信息:\n\n';
            for (const [key, value] of Object.entries(config)) {
                if (Array.isArray(value)) {
                    configText += `${key}:\n`;
                    value.forEach(item => configText += `  - ${item}\n`);
                } else {
                    configText += `${key}: ${value}\n`;
                }
            }
            
            configText += '\n💡 说明:\n';
            configText += '- 前端使用相对路径 /api 作为baseURL\n';
            configText += '- Nginx将 /api/* 请求代理到后端容器\n';
            configText += '- 后端提供兼容性路由支持旧的API路径\n';
            
            document.getElementById('configResult').textContent = configText;
        }

        // 页面加载时显示配置信息
        window.onload = function() {
            checkConfig();
        };
    </script>
</body>
</html>