<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ·æ–°é¡µé¢403é—®é¢˜æµ‹è¯•</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e8ed;
        }
        .test-section {
            margin: 25px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
            transition: all 0.3s ease;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        .result {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .result.success { background: #f0fff4; border-color: #9ae6b4; color: #22543d; }
        .result.error { background: #fed7d7; border-color: #feb2b2; color: #742a2a; }
        .result.info { background: #ebf8ff; border-color: #90cdf4; color: #2a4365; }
        .step {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #e2e8f0;
            background: white;
        }
        .step.success { border-left-color: #48bb78; background: #f0fff4; }
        .step.error { border-left-color: #f56565; background: #fed7d7; }
        .step.active { border-left-color: #667eea; background: #f0f4ff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” åˆ·æ–°é¡µé¢403é—®é¢˜æµ‹è¯•</h1>
            <p>æµ‹è¯•ç™»å½•æˆåŠŸååˆ·æ–°é¡µé¢æ—¶profileå’Œsummaryæ¥å£æ˜¯å¦æŠ¥403</p>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h3>
            <div id="steps">
                <div class="step" id="step1">1. æ¨¡æ‹Ÿç™»å½•è·å–token</div>
                <div class="step" id="step2">2. å°†tokenä¿å­˜åˆ°localStorage</div>
                <div class="step" id="step3">3. æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°ï¼ˆæ¸…é™¤å†…å­˜ä¸­çš„è®¤è¯çŠ¶æ€ï¼‰</div>
                <div class="step" id="step4">4. ä»localStorageæ¢å¤token</div>
                <div class="step" id="step5">5. æµ‹è¯•è°ƒç”¨profileå’Œsummaryæ¥å£</div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª æµ‹è¯•æ§åˆ¶</h3>
            <button onclick="runFullTest()">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <button onclick="testCurrentState()">ğŸ” æµ‹è¯•å½“å‰çŠ¶æ€</button>
            <button onclick="clearStorage()">ğŸ§¹ æ¸…é™¤å­˜å‚¨</button>
            <div id="testResult" class="result info">ç‚¹å‡»"è¿è¡Œå®Œæ•´æµ‹è¯•"å¼€å§‹æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ æ‰‹åŠ¨æµ‹è¯•</h3>
            <button onclick="manualLogin()" id="loginBtn">1. ç™»å½•</button>
            <button onclick="saveToStorage()" id="saveBtn" disabled>2. ä¿å­˜åˆ°localStorage</button>
            <button onclick="simulateRefresh()" id="refreshBtn" disabled>3. æ¨¡æ‹Ÿåˆ·æ–°</button>
            <button onclick="restoreFromStorage()" id="restoreBtn" disabled>4. æ¢å¤è®¤è¯çŠ¶æ€</button>
            <button onclick="testAPIs()" id="testBtn" disabled>5. æµ‹è¯•APIè°ƒç”¨</button>
            <div id="manualResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š localStorageçŠ¶æ€</h3>
            <button onclick="checkStorage()">æ£€æŸ¥å­˜å‚¨çŠ¶æ€</button>
            <div id="storageInfo" class="result info"></div>
        </div>
    </div>

    <script>
        let authToken = null;
        let testResults = [];

        // é…ç½®axios
        const api = axios.create({
            baseURL: 'http://localhost:8000',
            timeout: 15000,
            headers: { 'Content-Type': 'application/json' }
        });

        // è¯·æ±‚æ‹¦æˆªå™¨
        api.interceptors.request.use(config => {
            if (authToken) {
                config.headers.Authorization = `Bearer ${authToken}`;
                console.log('ğŸ”‘ æ·»åŠ Authorizationå¤´:', authToken.substring(0, 20) + '...');
            } else {
                console.log('âš ï¸ æ²¡æœ‰tokenï¼Œæœªæ·»åŠ Authorizationå¤´');
            }
            return config;
        });

        function updateStep(stepId, status) {
            const step = document.getElementById(stepId);
            step.className = `step ${status}`;
        }

        function logResult(message, type = 'info') {
            testResults.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            updateDisplay();
        }

        function updateDisplay() {
            const resultElement = document.getElementById('testResult');
            resultElement.textContent = testResults.join('\n');
            resultElement.scrollTop = resultElement.scrollHeight;
        }

        async function runFullTest() {
            testResults = [];
            logResult('ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•æµç¨‹...');
            
            try {
                // æ­¥éª¤1: ç™»å½•
                updateStep('step1', 'active');
                logResult('æ­¥éª¤1: å¼€å§‹ç™»å½•...');
                
                const loginResponse = await api.post('/api/v1/auth/login', {
                    username: 'admin',
                    password: 'admin123'
                });
                
                if (loginResponse.data.success) {
                    authToken = loginResponse.data.data.access_token;
                    updateStep('step1', 'success');
                    logResult('âœ… ç™»å½•æˆåŠŸï¼Œè·å–åˆ°token');
                } else {
                    throw new Error('ç™»å½•å¤±è´¥');
                }

                // æ­¥éª¤2: ä¿å­˜åˆ°localStorage
                updateStep('step2', 'active');
                logResult('æ­¥éª¤2: ä¿å­˜tokenåˆ°localStorage...');
                
                localStorage.setItem('access_token', authToken);
                localStorage.setItem('refresh_token', loginResponse.data.data.refresh_token);
                updateStep('step2', 'success');
                logResult('âœ… tokenå·²ä¿å­˜åˆ°localStorage');

                // æ­¥éª¤3: æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°
                updateStep('step3', 'active');
                logResult('æ­¥éª¤3: æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°ï¼ˆæ¸…é™¤å†…å­˜çŠ¶æ€ï¼‰...');
                
                authToken = null; // æ¸…é™¤å†…å­˜ä¸­çš„token
                updateStep('step3', 'success');
                logResult('âœ… å†…å­˜çŠ¶æ€å·²æ¸…é™¤');

                // æ­¥éª¤4: ä»localStorageæ¢å¤
                updateStep('step4', 'active');
                logResult('æ­¥éª¤4: ä»localStorageæ¢å¤token...');
                
                const savedToken = localStorage.getItem('access_token');
                if (savedToken) {
                    authToken = savedToken;
                    updateStep('step4', 'success');
                    logResult('âœ… tokenå·²ä»localStorageæ¢å¤');
                } else {
                    throw new Error('localStorageä¸­æ²¡æœ‰æ‰¾åˆ°token');
                }

                // æ­¥éª¤5: æµ‹è¯•APIè°ƒç”¨
                updateStep('step5', 'active');
                logResult('æ­¥éª¤5: æµ‹è¯•APIè°ƒç”¨...');
                
                // æµ‹è¯•auth/meæ¥å£
                try {
                    const meResponse = await api.get('/api/v1/auth/me');
                    logResult('âœ… /api/v1/auth/me è°ƒç”¨æˆåŠŸ');
                } catch (error) {
                    logResult(`âŒ /api/v1/auth/me è°ƒç”¨å¤±è´¥: ${error.response?.status} ${error.response?.data?.error_message || error.message}`);
                }

                // æµ‹è¯•profileæ¥å£
                try {
                    const profileResponse = await api.get('/api/user/profile');
                    logResult('âœ… /api/user/profile è°ƒç”¨æˆåŠŸ');
                } catch (error) {
                    logResult(`âŒ /api/user/profile è°ƒç”¨å¤±è´¥: ${error.response?.status} ${error.response?.data?.error_message || error.message}`);
                }

                // æµ‹è¯•summaryæ¥å£
                try {
                    const summaryResponse = await api.get('/api/dashboard/summary');
                    logResult('âœ… /api/dashboard/summary è°ƒç”¨æˆåŠŸ');
                } catch (error) {
                    logResult(`âŒ /api/dashboard/summary è°ƒç”¨å¤±è´¥: ${error.response?.status} ${error.response?.data?.error_message || error.message}`);
                }

                updateStep('step5', 'success');
                logResult('ğŸ‰ æµ‹è¯•å®Œæˆï¼');

            } catch (error) {
                logResult(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                // æ ‡è®°å½“å‰æ´»è·ƒæ­¥éª¤ä¸ºé”™è¯¯
                ['step1', 'step2', 'step3', 'step4', 'step5'].forEach(id => {
                    const step = document.getElementById(id);
                    if (step.className.includes('active')) {
                        updateStep(id, 'error');
                    }
                });
            }
        }

        async function testCurrentState() {
            testResults = [];
            logResult('ğŸ” æµ‹è¯•å½“å‰è®¤è¯çŠ¶æ€...');
            
            const savedToken = localStorage.getItem('access_token');
            if (savedToken) {
                logResult(`ğŸ“± localStorageä¸­æœ‰token: ${savedToken.substring(0, 20)}...`);
                authToken = savedToken;
            } else {
                logResult('ğŸ“± localStorageä¸­æ²¡æœ‰token');
            }
            
            if (authToken) {
                logResult(`ğŸ”‘ å½“å‰å†…å­˜ä¸­çš„token: ${authToken.substring(0, 20)}...`);
                
                // æµ‹è¯•å„ä¸ªæ¥å£
                const endpoints = [
                    '/api/v1/auth/me',
                    '/api/user/profile', 
                    '/api/dashboard/summary'
                ];
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await api.get(endpoint);
                        logResult(`âœ… ${endpoint}: ${response.status} - æˆåŠŸ`);
                    } catch (error) {
                        logResult(`âŒ ${endpoint}: ${error.response?.status || 'ERROR'} - ${error.response?.data?.error_message || error.message}`);
                    }
                }
            } else {
                logResult('âš ï¸ æ²¡æœ‰å¯ç”¨çš„token');
            }
        }

        function clearStorage() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            authToken = null;
            testResults = [];
            logResult('ğŸ§¹ å·²æ¸…é™¤localStorageå’Œå†…å­˜ä¸­çš„è®¤è¯ä¿¡æ¯');
            
            // é‡ç½®æ­¥éª¤çŠ¶æ€
            ['step1', 'step2', 'step3', 'step4', 'step5'].forEach(id => {
                updateStep(id, '');
            });
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            document.getElementById('loginBtn').disabled = false;
            document.getElementById('saveBtn').disabled = true;
            document.getElementById('refreshBtn').disabled = true;
            document.getElementById('restoreBtn').disabled = true;
            document.getElementById('testBtn').disabled = true;
        }

        // æ‰‹åŠ¨æµ‹è¯•å‡½æ•°
        async function manualLogin() {
            try {
                const response = await api.post('/api/v1/auth/login', {
                    username: 'admin',
                    password: 'admin123'
                });
                
                if (response.data.success) {
                    authToken = response.data.data.access_token;
                    document.getElementById('loginBtn').disabled = true;
                    document.getElementById('saveBtn').disabled = false;
                    document.getElementById('manualResult').textContent = 'âœ… ç™»å½•æˆåŠŸ';
                    document.getElementById('manualResult').className = 'result success';
                }
            } catch (error) {
                document.getElementById('manualResult').textContent = `âŒ ç™»å½•å¤±è´¥: ${error.message}`;
                document.getElementById('manualResult').className = 'result error';
            }
        }

        function saveToStorage() {
            if (authToken) {
                localStorage.setItem('access_token', authToken);
                document.getElementById('saveBtn').disabled = true;
                document.getElementById('refreshBtn').disabled = false;
                document.getElementById('manualResult').textContent = 'âœ… Tokenå·²ä¿å­˜åˆ°localStorage';
                document.getElementById('manualResult').className = 'result success';
            }
        }

        function simulateRefresh() {
            authToken = null;
            document.getElementById('refreshBtn').disabled = true;
            document.getElementById('restoreBtn').disabled = false;
            document.getElementById('manualResult').textContent = 'âœ… å·²æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°ï¼ˆæ¸…é™¤å†…å­˜çŠ¶æ€ï¼‰';
            document.getElementById('manualResult').className = 'result success';
        }

        function restoreFromStorage() {
            const savedToken = localStorage.getItem('access_token');
            if (savedToken) {
                authToken = savedToken;
                document.getElementById('restoreBtn').disabled = true;
                document.getElementById('testBtn').disabled = false;
                document.getElementById('manualResult').textContent = 'âœ… å·²ä»localStorageæ¢å¤token';
                document.getElementById('manualResult').className = 'result success';
            } else {
                document.getElementById('manualResult').textContent = 'âŒ localStorageä¸­æ²¡æœ‰æ‰¾åˆ°token';
                document.getElementById('manualResult').className = 'result error';
            }
        }

        async function testAPIs() {
            const results = [];
            const endpoints = [
                '/api/v1/auth/me',
                '/api/user/profile', 
                '/api/dashboard/summary'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await api.get(endpoint);
                    results.push(`âœ… ${endpoint}: æˆåŠŸ (${response.status})`);
                } catch (error) {
                    results.push(`âŒ ${endpoint}: å¤±è´¥ (${error.response?.status}) - ${error.response?.data?.error_message || error.message}`);
                }
            }
            
            document.getElementById('manualResult').textContent = results.join('\n');
            document.getElementById('manualResult').className = results.some(r => r.includes('âŒ')) ? 'result error' : 'result success';
        }

        function checkStorage() {
            const accessToken = localStorage.getItem('access_token');
            const refreshToken = localStorage.getItem('refresh_token');
            
            let info = 'ğŸ“Š localStorageçŠ¶æ€:\n\n';
            info += `Access Token: ${accessToken ? accessToken.substring(0, 50) + '...' : 'æ— '}\n`;
            info += `Refresh Token: ${refreshToken ? refreshToken.substring(0, 50) + '...' : 'æ— '}\n`;
            info += `å†…å­˜ä¸­çš„Token: ${authToken ? authToken.substring(0, 50) + '...' : 'æ— '}\n`;
            
            document.getElementById('storageInfo').textContent = info;
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å­˜å‚¨çŠ¶æ€
        window.onload = function() {
            checkStorage();
        };
    </script>
</body>
</html>