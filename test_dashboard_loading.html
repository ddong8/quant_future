<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»ªè¡¨æ¿åŠ è½½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #337ecc;
        }
        button.success {
            background: #67C23A;
        }
        button.danger {
            background: #F56C6C;
        }
        .success {
            color: #67C23A;
            font-weight: bold;
        }
        .error {
            color: #F56C6C;
            font-weight: bold;
        }
        .info {
            color: #909399;
        }
        pre {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .dashboard-preview {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background: #fafafa;
        }
        .stat-card {
            display: inline-block;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 5px;
            min-width: 150px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #409EFF;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ ä»ªè¡¨æ¿åŠ è½½æµ‹è¯•</h1>
        <p class="info">ä¸“é—¨æµ‹è¯•ä»ªè¡¨æ¿ç»„ä»¶çš„åŠ è½½å’Œæ¸²æŸ“é—®é¢˜</p>

        <div class="test-section">
            <h3>1. ç™»å½•å¹¶è·å–Token</h3>
            <button onclick="performLogin()">æ‰§è¡Œç™»å½•</button>
            <button onclick="clearAuth()">æ¸…é™¤è®¤è¯</button>
            <div id="login-result"></div>
        </div>

        <div class="test-section">
            <h3>2. æµ‹è¯•ä»ªè¡¨æ¿API</h3>
            <button onclick="testDashboardSummary()">æµ‹è¯•ä»ªè¡¨æ¿æ‘˜è¦</button>
            <button onclick="testUserProfile()">æµ‹è¯•ç”¨æˆ·èµ„æ–™</button>
            <button onclick="testAllDashboardAPIs()">æµ‹è¯•æ‰€æœ‰ä»ªè¡¨æ¿API</button>
            <div id="dashboard-api-result"></div>
        </div>

        <div class="test-section">
            <h3>3. æ¨¡æ‹Ÿå‰ç«¯ä»ªè¡¨æ¿æ¸²æŸ“</h3>
            <button onclick="simulateDashboardRender()">æ¨¡æ‹Ÿä»ªè¡¨æ¿æ¸²æŸ“</button>
            <button onclick="testFrontendIntegration()">æµ‹è¯•å‰ç«¯é›†æˆ</button>
            <div id="dashboard-render-result"></div>
        </div>

        <div class="test-section">
            <h3>4. ä»ªè¡¨æ¿æ•°æ®é¢„è§ˆ</h3>
            <div id="dashboard-preview" class="dashboard-preview">
                <p>ç‚¹å‡»ä¸Šé¢çš„æŒ‰é’®åŠ è½½ä»ªè¡¨æ¿æ•°æ®...</p>
            </div>
        </div>

        <div class="test-section">
            <h3>5. å‰ç«¯é¡µé¢æµ‹è¯•</h3>
            <button onclick="openFrontendDashboard()">æ‰“å¼€å‰ç«¯ä»ªè¡¨æ¿</button>
            <button onclick="checkFrontendConsole()">æ£€æŸ¥å‰ç«¯æ§åˆ¶å°</button>
            <div id="frontend-test-result"></div>
        </div>

        <div class="test-section">
            <h3>6. å®æ—¶æ—¥å¿—</h3>
            <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
            <div id="logs" class="log"></div>
        </div>
    </div>

    <script>
        let logs = [];
        let authToken = null;
        let dashboardData = {};

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push(logEntry);
            
            const logsDiv = document.getElementById('logs');
            const logElement = document.createElement('div');
            logElement.textContent = logEntry;
            logElement.className = type;
            logsDiv.appendChild(logElement);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function clearLogs() {
            logs = [];
            document.getElementById('logs').innerHTML = '';
        }

        async function performLogin() {
            log('ğŸ”„ å¼€å§‹ç™»å½•æµç¨‹...', 'info');
            
            try {
                const response = await fetch('http://localhost:3000/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });

                const data = await response.json();
                
                if (data.success && data.data && data.data.access_token) {
                    authToken = data.data.access_token;
                    localStorage.setItem('dashboard_test_token', authToken);
                    
                    log('âœ… ç™»å½•æˆåŠŸ', 'success');
                    document.getElementById('login-result').innerHTML = `
                        <div class="success">
                            <h4>âœ… ç™»å½•æˆåŠŸ</h4>
                            <p><strong>ç”¨æˆ·:</strong> ${data.data.username}</p>
                            <p><strong>è§’è‰²:</strong> ${data.data.role}</p>
                            <p><strong>Token:</strong> ${authToken.substring(0, 30)}...</p>
                        </div>
                    `;
                } else {
                    throw new Error('ç™»å½•å“åº”æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                log('âŒ ç™»å½•å¤±è´¥: ' + error.message, 'error');
                document.getElementById('login-result').innerHTML = `
                    <div class="error">
                        <h4>âŒ ç™»å½•å¤±è´¥</h4>
                        <p>é”™è¯¯: ${error.message}</p>
                    </div>
                `;
            }
        }

        function clearAuth() {
            authToken = null;
            localStorage.removeItem('dashboard_test_token');
            log('ğŸ—‘ï¸ è®¤è¯ä¿¡æ¯å·²æ¸…é™¤', 'info');
            document.getElementById('login-result').innerHTML = '<p>è®¤è¯ä¿¡æ¯å·²æ¸…é™¤</p>';
        }

        async function testDashboardSummary() {
            if (!authToken) {
                authToken = localStorage.getItem('dashboard_test_token');
                if (!authToken) {
                    log('âŒ è¯·å…ˆç™»å½•è·å–Token', 'error');
                    return;
                }
            }

            log('ğŸ”„ æµ‹è¯•ä»ªè¡¨æ¿æ‘˜è¦API...', 'info');
            
            try {
                const response = await fetch('http://localhost:3000/api/v1/dashboard/summary', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    dashboardData.summary = data.data;
                    log('âœ… ä»ªè¡¨æ¿æ‘˜è¦APIæµ‹è¯•æˆåŠŸ', 'success');
                    
                    document.getElementById('dashboard-api-result').innerHTML = `
                        <div class="success">
                            <h4>âœ… ä»ªè¡¨æ¿æ‘˜è¦APIæˆåŠŸ</h4>
                            <details>
                                <summary>æŸ¥çœ‹å“åº”æ•°æ®</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    throw new Error('ä»ªè¡¨æ¿æ‘˜è¦APIå“åº”æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                log('âŒ ä»ªè¡¨æ¿æ‘˜è¦APIæµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                document.getElementById('dashboard-api-result').innerHTML = `
                    <div class="error">
                        <h4>âŒ ä»ªè¡¨æ¿æ‘˜è¦APIå¤±è´¥</h4>
                        <p>é”™è¯¯: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function testUserProfile() {
            if (!authToken) {
                authToken = localStorage.getItem('dashboard_test_token');
                if (!authToken) {
                    log('âŒ è¯·å…ˆç™»å½•è·å–Token', 'error');
                    return;
                }
            }

            log('ğŸ”„ æµ‹è¯•ç”¨æˆ·èµ„æ–™API...', 'info');
            
            try {
                const response = await fetch('http://localhost:3000/api/v1/user/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    dashboardData.profile = data.data;
                    log('âœ… ç”¨æˆ·èµ„æ–™APIæµ‹è¯•æˆåŠŸ', 'success');
                    
                    document.getElementById('dashboard-api-result').innerHTML = `
                        <div class="success">
                            <h4>âœ… ç”¨æˆ·èµ„æ–™APIæˆåŠŸ</h4>
                            <details>
                                <summary>æŸ¥çœ‹å“åº”æ•°æ®</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    throw new Error('ç”¨æˆ·èµ„æ–™APIå“åº”æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                log('âŒ ç”¨æˆ·èµ„æ–™APIæµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                document.getElementById('dashboard-api-result').innerHTML = `
                    <div class="error">
                        <h4>âŒ ç”¨æˆ·èµ„æ–™APIå¤±è´¥</h4>
                        <p>é”™è¯¯: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function testAllDashboardAPIs() {
            log('ğŸ”„ æµ‹è¯•æ‰€æœ‰ä»ªè¡¨æ¿ç›¸å…³API...', 'info');
            
            await testDashboardSummary();
            await new Promise(resolve => setTimeout(resolve, 500)); // ç­‰å¾…500ms
            await testUserProfile();
            
            if (dashboardData.summary && dashboardData.profile) {
                log('âœ… æ‰€æœ‰ä»ªè¡¨æ¿APIæµ‹è¯•å®Œæˆ', 'success');
                simulateDashboardRender();
            }
        }

        function simulateDashboardRender() {
            log('ğŸ”„ æ¨¡æ‹Ÿä»ªè¡¨æ¿æ¸²æŸ“...', 'info');
            
            if (!dashboardData.summary || !dashboardData.profile) {
                log('âŒ ç¼ºå°‘ä»ªè¡¨æ¿æ•°æ®ï¼Œè¯·å…ˆæµ‹è¯•API', 'error');
                return;
            }

            const summary = dashboardData.summary;
            const profile = dashboardData.profile;

            // æ¨¡æ‹Ÿå‰ç«¯ä»ªè¡¨æ¿æ¸²æŸ“
            const dashboardHTML = `
                <h4>ğŸ“Š ä»ªè¡¨æ¿æ•°æ®é¢„è§ˆ</h4>
                <div style="margin-bottom: 15px;">
                    <strong>ç”¨æˆ·ä¿¡æ¯:</strong> ${profile.full_name} (${profile.username}) - ${profile.role}
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div class="stat-card">
                        <div class="stat-value">Â¥${summary.stats.account_balance.toFixed(2)}</div>
                        <div class="stat-label">è´¦æˆ·ä½™é¢</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${summary.stats.active_positions}</div>
                        <div class="stat-label">æ´»è·ƒæŒä»“</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${summary.stats.total_orders}</div>
                        <div class="stat-label">æ€»è®¢å•æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${summary.stats.total_strategies}</div>
                        <div class="stat-label">ç­–ç•¥æ•°é‡</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>å¸‚åœºçŠ¶æ€:</strong> <span style="color: ${summary.market_status === 'open' ? '#67C23A' : '#F56C6C'}">${summary.market_status === 'open' ? 'å¼€å¸‚' : 'é—­å¸‚'}</span>
                </div>
                
                <div>
                    <strong>æœ€è¿‘æ´»åŠ¨:</strong> ${summary.recent_activities.length} æ¡è®°å½•
                </div>
            `;

            document.getElementById('dashboard-preview').innerHTML = dashboardHTML;
            document.getElementById('dashboard-render-result').innerHTML = `
                <div class="success">
                    <h4>âœ… ä»ªè¡¨æ¿æ¸²æŸ“æ¨¡æ‹ŸæˆåŠŸ</h4>
                    <p>ä»ªè¡¨æ¿æ•°æ®å·²æˆåŠŸæ¸²æŸ“åˆ°é¢„è§ˆåŒºåŸŸ</p>
                </div>
            `;

            log('âœ… ä»ªè¡¨æ¿æ¸²æŸ“æ¨¡æ‹Ÿå®Œæˆ', 'success');
        }

        async function testFrontendIntegration() {
            log('ğŸ”„ æµ‹è¯•å‰ç«¯é›†æˆ...', 'info');
            
            try {
                // æµ‹è¯•å‰ç«¯é¡µé¢æ˜¯å¦å¯è®¿é—®
                const frontendResponse = await fetch('http://localhost:3000/');
                if (!frontendResponse.ok) {
                    throw new Error('å‰ç«¯é¡µé¢æ— æ³•è®¿é—®');
                }

                // æµ‹è¯•å‰ç«¯APIä»£ç†
                const apiResponse = await fetch('http://localhost:3000/api/v1/health/');
                if (!apiResponse.ok) {
                    throw new Error('å‰ç«¯APIä»£ç†æ— æ³•è®¿é—®');
                }

                log('âœ… å‰ç«¯é›†æˆæµ‹è¯•æˆåŠŸ', 'success');
                document.getElementById('dashboard-render-result').innerHTML = `
                    <div class="success">
                        <h4>âœ… å‰ç«¯é›†æˆæµ‹è¯•æˆåŠŸ</h4>
                        <p>å‰ç«¯é¡µé¢å’ŒAPIä»£ç†éƒ½æ­£å¸¸å·¥ä½œ</p>
                        <p>å¯ä»¥å°è¯•åœ¨å®é™…å‰ç«¯é¡µé¢ä¸­æµ‹è¯•ä»ªè¡¨æ¿åŠŸèƒ½</p>
                    </div>
                `;
            } catch (error) {
                log('âŒ å‰ç«¯é›†æˆæµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                document.getElementById('dashboard-render-result').innerHTML = `
                    <div class="error">
                        <h4>âŒ å‰ç«¯é›†æˆæµ‹è¯•å¤±è´¥</h4>
                        <p>é”™è¯¯: ${error.message}</p>
                    </div>
                `;
            }
        }

        function openFrontendDashboard() {
            log('ğŸ”„ æ‰“å¼€å‰ç«¯ä»ªè¡¨æ¿é¡µé¢...', 'info');
            
            const frontendWindow = window.open('http://localhost:3000', '_blank');
            
            if (frontendWindow) {
                log('âœ… å‰ç«¯é¡µé¢å·²æ‰“å¼€', 'success');
                document.getElementById('frontend-test-result').innerHTML = `
                    <div class="success">
                        <h4>âœ… å‰ç«¯é¡µé¢å·²æ‰“å¼€</h4>
                        <p>è¯·åœ¨æ–°çª—å£ä¸­è¿›è¡Œä»¥ä¸‹æµ‹è¯•ï¼š</p>
                        <ol>
                            <li>ä½¿ç”¨ admin/admin123 ç™»å½•</li>
                            <li>æ£€æŸ¥æ˜¯å¦æˆåŠŸè·³è½¬åˆ°ä»ªè¡¨æ¿</li>
                            <li>æŸ¥çœ‹ä»ªè¡¨æ¿æ•°æ®æ˜¯å¦æ­£ç¡®æ˜¾ç¤º</li>
                            <li>æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯</li>
                        </ol>
                        <p><strong>å¦‚æœä»ç„¶æ˜¾ç¤º"é¡µé¢å‡ºç°é”™è¯¯"ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯</strong></p>
                    </div>
                `;
            } else {
                log('âŒ æ— æ³•æ‰“å¼€å‰ç«¯é¡µé¢', 'error');
                document.getElementById('frontend-test-result').innerHTML = `
                    <div class="error">
                        <h4>âŒ æ— æ³•æ‰“å¼€å‰ç«¯é¡µé¢</h4>
                        <p>è¯·æ‰‹åŠ¨è®¿é—®: <a href="http://localhost:3000" target="_blank">http://localhost:3000</a></p>
                    </div>
                `;
            }
        }

        function checkFrontendConsole() {
            log('ğŸ“‹ å‰ç«¯æ§åˆ¶å°æ£€æŸ¥æŒ‡å—', 'info');
            document.getElementById('frontend-test-result').innerHTML = `
                <div class="info">
                    <h4>ğŸ“‹ å‰ç«¯æ§åˆ¶å°æ£€æŸ¥æŒ‡å—</h4>
                    <p>è¯·åœ¨å‰ç«¯é¡µé¢ä¸­æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œç„¶åæ£€æŸ¥ï¼š</p>
                    <ol>
                        <li><strong>Console æ ‡ç­¾é¡µ</strong>ï¼šæŸ¥çœ‹æ˜¯å¦æœ‰ JavaScript é”™è¯¯</li>
                        <li><strong>Network æ ‡ç­¾é¡µ</strong>ï¼šæŸ¥çœ‹ API è¯·æ±‚æ˜¯å¦æˆåŠŸ</li>
                        <li><strong>Application æ ‡ç­¾é¡µ</strong>ï¼šæŸ¥çœ‹ localStorage ä¸­çš„è®¤è¯ä¿¡æ¯</li>
                    </ol>
                    <p><strong>å¸¸è§é”™è¯¯ç±»å‹ï¼š</strong></p>
                    <ul>
                        <li>ç»„ä»¶åŠ è½½é”™è¯¯ï¼šRealTimeChart æˆ– RealTimeTable ç»„ä»¶ä¸å­˜åœ¨</li>
                        <li>API è°ƒç”¨é”™è¯¯ï¼šç½‘ç»œè¯·æ±‚å¤±è´¥æˆ–å“åº”æ ¼å¼é”™è¯¯</li>
                        <li>è®¤è¯é”™è¯¯ï¼šToken æ— æ•ˆæˆ–è¿‡æœŸ</li>
                        <li>è·¯ç”±é”™è¯¯ï¼šé¡µé¢è·³è½¬å¤±è´¥</li>
                    </ul>
                </div>
            `;
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('ğŸš€ ä»ªè¡¨æ¿åŠ è½½æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            log('ğŸ“‹ æµ‹è¯•æµç¨‹:', 'info');
            log('  1. å…ˆæ‰§è¡Œç™»å½•è·å–Token', 'info');
            log('  2. æµ‹è¯•ä»ªè¡¨æ¿ç›¸å…³API', 'info');
            log('  3. æ¨¡æ‹Ÿä»ªè¡¨æ¿æ¸²æŸ“', 'info');
            log('  4. åœ¨å®é™…å‰ç«¯é¡µé¢ä¸­éªŒè¯', 'info');
            
            // å°è¯•ä»localStorageæ¢å¤token
            const savedToken = localStorage.getItem('dashboard_test_token');
            if (savedToken) {
                authToken = savedToken;
                log('ğŸ“± ä»localStorageæ¢å¤äº†Token', 'info');
            }
        };
    </script>
</body>
</html>