<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ é‡åŒ–äº¤æ˜“å¹³å° - WebSocketå®æ—¶æ•°æ®</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f5f7fa; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: 20px; text-align: center; box-shadow: 0 2px 12px rgba(0,0,0,0.1); border-radius: 8px; margin-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .realtime-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); margin: 20px 0; }
        .price-display { font-size: 2em; font-weight: bold; font-family: monospace; }
        .price-up { color: #27ae60; }
        .price-down { color: #e74c3c; }
        .price-neutral { color: #3498db; }
        .connection-status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message-log { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 6px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>ğŸš€ é‡åŒ–äº¤æ˜“å¹³å° - å®æ—¶æ•°æ®æ¼”ç¤º</h1>
            <p>WebSocketå®æ—¶è¡Œæƒ…æ¨é€æ¼”ç¤º</p>
        </div>
        
        <div class="container">
            <!-- è¿æ¥çŠ¶æ€ -->
            <div class="realtime-section">
                <h2>ğŸ”— è¿æ¥çŠ¶æ€</h2>
                <div :class="['connection-status', wsConnected ? 'connected' : 'disconnected']">
                    {{ wsConnected ? 'âœ… WebSocketå·²è¿æ¥' : 'âŒ WebSocketæœªè¿æ¥' }}
                </div>
                <el-button @click="connectWebSocket" :disabled="wsConnected" type="primary">è¿æ¥WebSocket</el-button>
                <el-button @click="disconnectWebSocket" :disabled="!wsConnected" type="danger">æ–­å¼€è¿æ¥</el-button>
            </div>

            <!-- å®æ—¶è¡Œæƒ… -->
            <div class="realtime-section">
                <h2>ğŸ“Š å®æ—¶è¡Œæƒ…</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div v-for="quote in realtimeQuotes" :key="quote.symbol" style="border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
                        <h3>{{ quote.name }}</h3>
                        <div :class="['price-display', getPriceClass(quote)]">
                            Â¥{{ quote.last_price }}
                        </div>
                        <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                            å˜åŠ¨: {{ quote.change > 0 ? '+' : '' }}{{ quote.change }} ({{ quote.change_percent > 0 ? '+' : '' }}{{ quote.change_percent }}%)
                        </div>
                        <div style="font-size: 0.8em; color: #999; margin-top: 5px;">
                            æ›´æ–°æ—¶é—´: {{ formatTime(quote.timestamp) }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¶ˆæ¯æ—¥å¿— -->
            <div class="realtime-section">
                <h2>ğŸ“ æ¶ˆæ¯æ—¥å¿—</h2>
                <div class="message-log" ref="messageLog">{{ messageLog }}</div>
                <el-button @click="clearLog" style="margin-top: 10px;">æ¸…ç©ºæ—¥å¿—</el-button>
            </div>

            <!-- æ¨¡æ‹Ÿæ•°æ®æ§åˆ¶ -->
            <div class="realtime-section">
                <h2>ğŸ® æ¨¡æ‹Ÿæ§åˆ¶</h2>
                <p>ç”±äºè¿™æ˜¯æ¼”ç¤ºç‰ˆæœ¬ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æ¥å±•ç¤ºå®æ—¶åŠŸèƒ½ï¼š</p>
                <el-button @click="startSimulation" :disabled="simulationRunning" type="success">å¼€å§‹æ¨¡æ‹Ÿæ•°æ®</el-button>
                <el-button @click="stopSimulation" :disabled="!simulationRunning" type="warning">åœæ­¢æ¨¡æ‹Ÿ</el-button>
                <div style="margin-top: 10px;">
                    <span>æ›´æ–°é¢‘ç‡: </span>
                    <el-slider v-model="updateInterval" :min="500" :max="5000" :step="500" style="width: 200px; display: inline-block; margin: 0 10px;"></el-slider>
                    <span>{{ updateInterval }}ms</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElButton, ElSlider, ElMessage } = ElementPlus;

        createApp({
            components: {
                ElButton,
                ElSlider
            },
            data() {
                return {
                    wsConnected: false,
                    ws: null,
                    messageLog: 'ç­‰å¾…è¿æ¥WebSocket...\n',
                    simulationRunning: false,
                    simulationTimer: null,
                    updateInterval: 1000,
                    realtimeQuotes: [
                        {
                            symbol: 'SHFE.cu2401',
                            name: 'æ²ªé“œ2401',
                            last_price: 68500.0,
                            change: 0,
                            change_percent: 0,
                            timestamp: new Date().toISOString()
                        },
                        {
                            symbol: 'SHFE.au2312',
                            name: 'æ²ªé‡‘2312',
                            last_price: 456.8,
                            change: 0,
                            change_percent: 0,
                            timestamp: new Date().toISOString()
                        },
                        {
                            symbol: 'DCE.i2401',
                            name: 'é“çŸ¿çŸ³2401',
                            last_price: 785.5,
                            change: 0,
                            change_percent: 0,
                            timestamp: new Date().toISOString()
                        }
                    ]
                }
            },
            methods: {
                connectWebSocket() {
                    try {
                        // å°è¯•è¿æ¥åˆ°åç«¯WebSocketï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        this.ws = new WebSocket('ws://localhost:8000/api/v1/ws');
                        
                        this.ws.onopen = () => {
                            this.wsConnected = true;
                            this.addLog('âœ… WebSocketè¿æ¥æˆåŠŸ');
                            ElMessage.success('WebSocketè¿æ¥æˆåŠŸ');
                        };
                        
                        this.ws.onmessage = (event) => {
                            const data = JSON.parse(event.data);
                            this.handleWebSocketMessage(data);
                        };
                        
                        this.ws.onclose = () => {
                            this.wsConnected = false;
                            this.addLog('âŒ WebSocketè¿æ¥å…³é—­');
                            ElMessage.warning('WebSocketè¿æ¥å…³é—­');
                        };
                        
                        this.ws.onerror = (error) => {
                            this.addLog('ğŸš« WebSocketè¿æ¥é”™è¯¯: ' + error.message);
                            ElMessage.error('WebSocketè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼');
                            // å¦‚æœWebSocketè¿æ¥å¤±è´¥ï¼Œå¯ç”¨æ¨¡æ‹Ÿæ¨¡å¼
                            this.wsConnected = true; // æ¨¡æ‹Ÿè¿æ¥æˆåŠŸ
                            this.startSimulation();
                        };
                        
                    } catch (error) {
                        this.addLog('ğŸš« WebSocketåˆå§‹åŒ–å¤±è´¥: ' + error.message);
                        ElMessage.error('WebSocketä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼');
                        // å¯ç”¨æ¨¡æ‹Ÿæ¨¡å¼
                        this.wsConnected = true;
                        this.startSimulation();
                    }
                },
                
                disconnectWebSocket() {
                    if (this.ws) {
                        this.ws.close();
                    }
                    this.stopSimulation();
                    this.wsConnected = false;
                    this.addLog('ğŸ”Œ æ‰‹åŠ¨æ–­å¼€WebSocketè¿æ¥');
                },
                
                handleWebSocketMessage(data) {
                    this.addLog('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ' + JSON.stringify(data));
                    
                    if (data.type === 'quote_update') {
                        this.updateQuote(data.data);
                    }
                },
                
                updateQuote(quoteData) {
                    const index = this.realtimeQuotes.findIndex(q => q.symbol === quoteData.symbol);
                    if (index !== -1) {
                        const oldPrice = this.realtimeQuotes[index].last_price;
                        this.realtimeQuotes[index] = {
                            ...this.realtimeQuotes[index],
                            ...quoteData,
                            change: quoteData.last_price - oldPrice,
                            change_percent: ((quoteData.last_price - oldPrice) / oldPrice * 100).toFixed(2),
                            timestamp: new Date().toISOString()
                        };
                    }
                },
                
                startSimulation() {
                    if (this.simulationRunning) return;
                    
                    this.simulationRunning = true;
                    this.addLog('ğŸ® å¼€å§‹æ¨¡æ‹Ÿå®æ—¶æ•°æ®æ¨é€');
                    
                    this.simulationTimer = setInterval(() => {
                        this.realtimeQuotes.forEach(quote => {
                            const oldPrice = quote.last_price;
                            // æ¨¡æ‹Ÿä»·æ ¼æ³¢åŠ¨ (-2% åˆ° +2%)
                            const changePercent = (Math.random() - 0.5) * 0.04;
                            const newPrice = oldPrice * (1 + changePercent);
                            const change = newPrice - oldPrice;
                            
                            quote.last_price = Math.round(newPrice * 100) / 100;
                            quote.change = Math.round(change * 100) / 100;
                            quote.change_percent = Math.round(changePercent * 10000) / 100;
                            quote.timestamp = new Date().toISOString();
                        });
                        
                        this.addLog(`ğŸ“Š æ›´æ–°è¡Œæƒ…æ•°æ® - ${this.formatTime(new Date().toISOString())}`);
                    }, this.updateInterval);
                },
                
                stopSimulation() {
                    if (this.simulationTimer) {
                        clearInterval(this.simulationTimer);
                        this.simulationTimer = null;
                    }
                    this.simulationRunning = false;
                    this.addLog('â¹ï¸ åœæ­¢æ¨¡æ‹Ÿæ•°æ®æ¨é€');
                },
                
                addLog(message) {
                    const timestamp = new Date().toLocaleTimeString();
                    this.messageLog += `[${timestamp}] ${message}\n`;
                    this.$nextTick(() => {
                        const logElement = this.$refs.messageLog;
                        if (logElement) {
                            logElement.scrollTop = logElement.scrollHeight;
                        }
                    });
                },
                
                clearLog() {
                    this.messageLog = '';
                },
                
                getPriceClass(quote) {
                    if (quote.change > 0) return 'price-up';
                    if (quote.change < 0) return 'price-down';
                    return 'price-neutral';
                },
                
                formatTime(timestamp) {
                    return new Date(timestamp).toLocaleTimeString();
                }
            },
            
            watch: {
                updateInterval(newVal) {
                    if (this.simulationRunning) {
                        this.stopSimulation();
                        this.startSimulation();
                    }
                }
            },
            
            beforeUnmount() {
                this.stopSimulation();
                if (this.ws) {
                    this.ws.close();
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>